<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naranjo Assessment & Allergy Card</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PDF & Canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Container for hidden generation templates */
        #hidden-templates-container {
            position: fixed;
            left: -9999px;
            top: 0;
        }

        /* --- A5 Card Design --- */
        .allergy-card {
            width: 1000px; /* High res base */
            min-height: 680px; 
            height: auto;      
            background-color: #eff6ff; /* Light Blue */
            border: 6px solid #2563eb; 
            border-radius: 24px;
            padding: 30px;
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            color: #333;
            position: relative;
        }

        .card-header {
            text-align: center;
            color: #1e40af;
            font-weight: 800;
            font-size: 36px;
            border-bottom: 4px solid #2563eb;
            padding-bottom: 15px;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .card-section {
            display: flex;
            margin-bottom: 12px;
            align-items: baseline;
        }

        .card-label {
            font-size: 24px;
            font-weight: 700;
            width: 160px;
            flex-shrink: 0;
            color: #4b5563;
        }

        .card-value {
            font-size: 26px;
            font-weight: 600;
            color: #000;
            border-bottom: 2px dotted #9ca3af;
            flex-grow: 1;
            padding-left: 10px;
            padding-bottom: 4px;
            line-height: 1.4;
        }

        .drug-table {
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            border-collapse: separate;
            border-spacing: 0;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }
        
        .drug-table th {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 800;
            font-size: 20px;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 2px solid #3b82f6;
        }

        .drug-table td {
            padding: 8px 12px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            line-height: 1.3;
            vertical-align: top;
        }
        
        .drug-table tr:last-child td { border-bottom: none; }

        .card-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-top: 2px solid #bfdbfe;
            padding-top: 15px;
        }

        .footer-info {
            font-size: 20px;
            font-weight: 600;
            color: #1e40af;
            line-height: 1.5;
        }

        .footer-note {
            font-size: 18px;
            color: #dc2626;
            font-weight: 700;
            text-align: right;
        }

        /* --- A4 Report Design --- */
        .a4-report {
            width: 794px; /* A4 width in pixels at 96dpi approx */
            height: 1123px; /* A4 height */
            background-color: white;
            padding: 40px;
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            color: #000;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .rpt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .rpt-title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .rpt-subtitle { font-size: 16px; color: #444; }

        .rpt-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .rpt-row { display: flex; align-items: baseline; }
        .rpt-label { font-weight: bold; margin-right: 5px; width: 80px; }
        .rpt-val { border-bottom: 1px dotted #666; flex-grow: 1; padding-left: 5px; font-weight: 500;}

        .rpt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .rpt-table th, .rpt-table td {
            border: 1px solid #000;
            padding: 6px;
        }

        .rpt-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
        .rpt-col-q { text-align: left; }
        .rpt-col-ans { text-align: center; width: 40px; }
        .rpt-col-score { text-align: center; width: 50px; }

        .rpt-result-box {
            border: 2px solid #000;
            padding: 15px;
            margin-bottom: 30px;
            background-color: #f9fafb;
        }

        .rpt-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            padding-top: 20px;
        }
        
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .sig-line { border-bottom: 1px solid #000; height: 30px; margin-bottom: 5px; }

        /* Utility */
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight" id="app-title">Naranjo Assessment</h1>
                <p class="text-blue-100 text-sm" id="app-subtitle">Adverse Drug Reaction Probability Scale & Allergy Card Generator</p>
            </div>
            <div class="flex space-x-2 bg-blue-700 p-1 rounded-lg">
                <button onclick="setLanguage('en')" id="btn-en" class="px-4 py-1 rounded transition-colors text-sm font-medium">EN</button>
                <button onclick="setLanguage('th')" id="btn-th" class="px-4 py-1 rounded bg-white text-blue-700 shadow text-sm font-medium">TH</button>
            </div>
        </div>

        <div class="p-6">
            <!-- 1. Patient Information -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-600 py-1 px-2 rounded mr-2 text-sm">1</span>
                    <span id="sec-patient">Patient Information</span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-name">Patient Name</label>
                        <input type="text" id="inp-name" class="w-full border-gray-300 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="...">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-hn">HN</label>
                        <input type="text" id="inp-hn" class="w-full border-gray-300 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="...">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-unit">Assessing Unit (Hospital/Pharmacy)</label>
                        <input type="text" id="inp-unit" class="w-full border-gray-300 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-date">Date</label>
                        <input type="date" id="inp-date" class="w-full border-gray-300 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Pharmacist -->
                    <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-blue-800 mb-1" id="lbl-pharm">Pharmacist Name</label>
                            <input type="text" id="inp-pharm" class="w-full border-blue-200 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="...">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-blue-800 mb-1" id="lbl-license">License No. (ภ.)</label>
                            <input type="text" id="inp-license" class="w-full border-blue-200 rounded-md shadow-sm border p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="ภ.xxxxx">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. History Drugs -->
            <div class="mb-8 bg-yellow-50 p-5 rounded-xl border border-yellow-200">
                <h2 class="text-lg font-bold text-yellow-800 mb-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="sec-history">Old History (Known Allergies)</span>
                    </div>
                </h2>
                <!-- Fixed: Added id="desc-history" back -->
                <p class="text-sm text-gray-600 mb-3" id="desc-history">Add known allergies here. These will be included in the card as "History (H)".</p>

                <div class="flex flex-col md:flex-row gap-3 mb-3">
                    <input type="text" id="hist-drug" placeholder="Drug Name" class="flex-1 border-gray-300 rounded-md shadow-sm border p-2 text-sm">
                    <input type="text" id="hist-sym" placeholder="Symptom" class="flex-1 border-gray-300 rounded-md shadow-sm border p-2 text-sm">
                    <button onclick="addHistoryItem()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md font-bold text-sm shadow transition">
                        + Add
                    </button>
                </div>
                <ul id="history-list" class="space-y-2"></ul>
            </div>

            <!-- 3. Current Assessment -->
            <div class="mb-8 border-2 border-blue-100 rounded-xl p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-800 flex items-center">
                        <span class="bg-blue-600 text-white py-1 px-2 rounded mr-2 text-sm">2</span>
                        <span id="sec-current">Current Naranjo Assessment</span>
                    </h2>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="chk-assess" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked onchange="toggleAssessment()">
                        <span class="text-sm font-bold text-gray-700" id="lbl-enable-assess">Perform Assessment</span>
                    </label>
                </div>

                <div id="assessment-panel" class="transition-all duration-300">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded-lg">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-drug">Suspected Drug (New)</label>
                            <input type="text" id="inp-drug" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 font-semibold text-blue-900">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" id="lbl-symptom">Adverse Reaction</label>
                            <input type="text" id="inp-symptom" class="w-full border-gray-300 rounded-md shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase w-3/5">Question</th>
                                    <th class="px-2 py-2 text-center text-xs font-bold text-gray-500 uppercase w-1/12">Yes</th>
                                    <th class="px-2 py-2 text-center text-xs font-bold text-gray-500 uppercase w-1/12">No</th>
                                    <th class="px-2 py-2 text-center text-xs font-bold text-gray-500 uppercase w-1/12">Unk</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="question-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="assessment-disabled-msg" class="hidden p-4 text-center text-gray-400 italic bg-gray-50 rounded-lg">
                    Assessment disabled.
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col items-center space-y-6">
                <!-- Main Action: Calculate -->
                <button onclick="calculateAndShowResult()" id="btn-calc-main" class="w-full md:w-2/3 px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-lg text-lg font-bold transition duration-200 flex items-center justify-center transform hover:scale-105">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span id="btn-calc-text">Calculate Score</span>
                </button>

                <!-- Error Alert -->
                <div id="alert-box" class="hidden w-full md:w-2/3 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow">
                    <p class="font-bold">Cannot Generate</p>
                    <p id="alert-msg">Something went wrong.</p>
                </div>

                <!-- Success / Result Area -->
                <div id="result-container" class="hidden w-full bg-green-50 border border-green-200 rounded-xl p-6">
                    <div class="text-center mb-6">
                        <h3 class="text-gray-600 font-bold uppercase tracking-widest text-sm mb-1" id="res-label">Assessment Result</h3>
                        <div class="flex justify-center items-baseline space-x-2">
                            <span class="text-5xl font-extrabold" id="score-val">0</span>
                        </div>
                        <span class="text-xl font-bold mt-2 block" id="interp-val">-</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Button A5 Card -->
                        <button onclick="generateCard()" class="w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow font-bold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            <span id="btn-dl-card">Download Card (A5 PDF)</span>
                        </button>

                        <!-- Button A4 Report -->
                        <button onclick="generateReport()" id="btn-gen-report" class="w-full px-6 py-3 bg-gray-700 hover:bg-gray-800 text-white rounded-lg shadow font-bold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span id="btn-dl-report">Download Report (A4 PDF)</span>
                        </button>
                    </div>
                    <div id="download-status" class="text-center text-sm text-gray-500 mt-4 font-semibold h-6"></div>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 border-t text-center text-xs text-gray-400">
            Ref: Naranjo CA et al. Clin Pharmacol Ther 1981; 30: 239-245. Developed by Opioid.apisit 
        </div>
    </div>

    <!-- Hidden Containers -->
    <div id="hidden-templates-container">
        
        <!-- 1. A5 Allergy Card Template -->
        <div id="pdf-card" class="allergy-card">
            <div class="card-header" id="card-header-text">บัตรแพ้ยา (Drug Allergy Card)</div>
            <div class="card-section">
                <div class="card-label" id="c-lbl-name">ชื่อ-สกุล:</div>
                <div class="card-value" id="c-val-name">-</div>
            </div>
            <div class="card-section">
                <div class="card-label" id="c-lbl-hn">HN:</div>
                <div class="card-value" id="c-val-hn">-</div>
            </div>
            <table class="drug-table">
                <thead>
                    <tr>
                        <th style="width: 35%;" id="th-drug">ยาที่แพ้ (Drug Name)</th>
                        <th style="width: 35%;" id="th-sym">อาการ (Symptoms)</th>
                        <th style="width: 30%;" id="th-res">ผลประเมิน (Result)</th>
                    </tr>
                </thead>
                <tbody id="c-table-body"></tbody>
            </table>
            <div class="card-footer">
                <div class="footer-info">
                    <div class="flex mb-2">
                        <span class="font-bold mr-2" id="c-lbl-unit">หน่วยงาน:</span>
                        <span id="c-val-unit">-</span>
                    </div>
                    <div class="flex mb-2">
                        <span class="font-bold mr-2" id="c-lbl-pharm">เภสัชกร:</span>
                        <span id="c-val-pharm">-</span>
                    </div>
                    <div class="flex">
                        <span class="font-bold mr-2" id="c-lbl-date">วันที่:</span>
                        <span id="c-val-date">-</span>
                    </div>
                </div>
                <div class="footer-note">
                    โปรดแสดงบัตรนี้ทุกครั้งที่เข้ารับบริการ<br>Please show this card every visit.
                </div>
            </div>
        </div>

        <!-- 2. A4 Assessment Report Template -->
        <div id="pdf-report" class="a4-report">
            <div class="rpt-header">
                <div class="rpt-title">Naranjo Adverse Drug Reaction Probability Scale</div>
                <div class="rpt-subtitle">แบบประเมินความน่าจะเป็นของอาการแพ้ยา</div>
            </div>

            <div class="rpt-info-grid">
                <div class="rpt-row">
                    <div class="rpt-label">Patient:</div>
                    <div class="rpt-val" id="r-val-name">-</div>
                </div>
                <div class="rpt-row">
                    <div class="rpt-label">HN:</div>
                    <div class="rpt-val" id="r-val-hn">-</div>
                </div>
                <div class="rpt-row">
                    <div class="rpt-label">Unit:</div>
                    <div class="rpt-val" id="r-val-unit">-</div>
                </div>
                <div class="rpt-row">
                    <div class="rpt-label">Date:</div>
                    <div class="rpt-val" id="r-val-date">-</div>
                </div>
            </div>
            
            <div class="rpt-result-box" style="border:1px solid #ddd; padding:10px; margin-bottom:20px;">
                 <div class="rpt-row">
                    <div class="rpt-label" style="width:120px;">Suspected Drug:</div>
                    <div class="rpt-val" id="r-val-drug" style="font-weight:800;">-</div>
                </div>
                <div class="rpt-row" style="margin-top:8px;">
                    <div class="rpt-label" style="width:120px;">Reaction:</div>
                    <div class="rpt-val" id="r-val-sym">-</div>
                </div>
            </div>

            <table class="rpt-table">
                <thead>
                    <tr>
                        <th style="width:60%">Question / คำถาม</th>
                        <th style="width:10%">Yes</th>
                        <th style="width:10%">No</th>
                        <th style="width:10%">Unk</th>
                        <th style="width:10%">Score</th>
                    </tr>
                </thead>
                <tbody id="r-table-body">
                    <!-- Generated Rows -->
                </tbody>
            </table>

            <div class="rpt-result-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:18px; font-weight:bold;">Total Score (คะแนนรวม)</div>
                        <div style="font-size:14px; color:#555;">≥9:Definite, 5-8:Probable, 1-4:Possible, ≤0:Doubtful</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:32px; font-weight:800; color:#2563eb;" id="r-val-score">0</div>
                        <div style="font-size:18px; font-weight:bold;" id="r-val-interp">-</div>
                    </div>
                </div>
            </div>

            <div class="rpt-footer">
                <div class="signature-box">
                    <div class="sig-line"></div>
                    <div id="r-sig-pharm">Pharmacist</div>
                    <div style="font-size:12px; color:#666;">Evaluating Pharmacist</div>
                </div>
                <div class="signature-box">
                    <div class="sig-line"></div>
                    <div>Physician / Witness</div>
                    <div style="font-size:12px; color:#666;">(Optional)</div>
                </div>
            </div>
            <div style="text-align:center; font-size:10px; color:#999; margin-top:20px;">
                Generated by Naranjo Web App
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const questions = [
            { id: 1, en: "1. Are there previous conclusive reports on this reaction?", th: "1. เคยมีรายงานสรุปแน่ชัดเกี่ยวกับอาการนี้มาก่อนหรือไม่?", y: 1, n: 0, u: 0 },
            { id: 2, en: "2. Did the adverse event appear after the suspected drug was administered?", th: "2. อาการเกิดขึ้นหลังจากได้รับยาที่สงสัยใช่หรือไม่?", y: 2, n: -1, u: 0 },
            { id: 3, en: "3. Did the adverse reaction improve when the drug was discontinued or a specific antagonist was administered?", th: "3. อาการดีขึ้นเมื่อหยุดยา หรือได้รับยาต้านจำเพาะหรือไม่?", y: 1, n: 0, u: 0 },
            { id: 4, en: "4. Did the adverse reaction reappear when the drug was readministered?", th: "4. อาการกลับมาเป็นซ้ำเมื่อได้รับยาเดิมอีกครั้งหรือไม่?", y: 2, n: -1, u: 0 },
            { id: 5, en: "5. Are there alternative causes (other than the drug) that could on their own have caused the reaction?", th: "5. มีสาเหตุอื่น (นอกจากยา) ที่อธิบายอาการนี้ได้หรือไม่?", y: -1, n: 2, u: 0 },
            { id: 6, en: "6. Did the reaction reappear when a placebo was given?", th: "6. อาการกำเริบเมื่อได้รับยาหลอก (Placebo) หรือไม่?", y: -1, n: 1, u: 0 },
            { id: 7, en: "7. Was the drug detected in the blood (or other fluids) in concentrations known to be toxic?", th: "7. ตรวจพบระดับยาในเลือด (หรือสารคัดหลั่ง) ในระดับที่เป็นพิษหรือไม่?", y: 1, n: 0, u: 0 },
            { id: 8, en: "8. Was the reaction more severe when the dose was increased or less severe when the dose was decreased?", th: "8. อาการรุนแรงขึ้นเมื่อเพิ่มขนาดยา หรือลดลงเมื่อลดขนาดยาหรือไม่?", y: 1, n: 0, u: 0 },
            { id: 9, en: "9. Did the patient have a similar reaction to the same or similar drugs in any previous exposure?", th: "9. ผู้ป่วยเคยมีอาการคล้ายกันกับยาตัวเดิมหรือยาที่คล้ายกันในอดีตหรือไม่?", y: 1, n: 0, u: 0 },
            { id: 10, en: "10. Was the adverse event confirmed by any objective evidence?", th: "10. อาการไม่พึงประสงค์ได้รับการยืนยันด้วยหลักฐานเชิงประจักษ์หรือไม่?", y: 1, n: 0, u: 0 }
        ];

        const uiText = {
            en: {
                title: "Naranjo Assessment",
                subtitle: "Adverse Drug Reaction Probability Scale",
                secPatient: "Patient Information",
                secHistory: "Old History (Known Allergies)",
                descHistory: "Add known allergies here. Included as 'History (H)'.",
                secCurrent: "Current Naranjo Assessment",
                lblEnable: "Perform Assessment",
                lbl: { name: "Name", hn: "HN", unit: "Unit", date: "Date", pharm: "Pharmacist", license: "License", drug: "Suspected Drug", sym: "Reaction" },
                btnCalc: "Calculate Score",
                btnDlCard: "Download Card (A5 PDF)",
                btnDlReport: "Download Report (A4 PDF)",
                resLabel: "Assessment Result",
                alertDoubtful: "Result is Doubtful (Score ≤ 0). Cannot generate card for this drug.",
                alertNoData: "Please add History Drug or perform Valid Assessment.",
                thDrug: "Drug Name", thSym: "Symptoms", thRes: "Result",
                c_lbl: { name: "Name:", hn: "HN:", unit: "Unit:", pharm: "Pharmacist:", date: "Date:" }
            },
            th: {
                title: "แบบประเมิน Naranjo",
                subtitle: "เกณฑ์การประเมินความน่าจะเป็นของอาการแพ้ยา",
                secPatient: "ข้อมูลผู้ป่วย",
                secHistory: "ประวัติการแพ้ยาเดิม (History)",
                descHistory: "เพิ่มรายการยาที่ทราบประวัติแพ้อยู่แล้ว (ระบุเป็นประวัติเก่า H)",
                secCurrent: "การประเมิน Naranjo (ครั้งนี้)",
                lblEnable: "ทำการประเมิน",
                lbl: { name: "ชื่อ-สกุล", hn: "HN", unit: "หน่วยงานที่ประเมิน", date: "วันที่", pharm: "เภสัชกรผู้ประเมิน", license: "เลขใบประกอบฯ (ภ.)", drug: "ยาที่สงสัย (ใหม่)", sym: "อาการที่พบ" },
                btnCalc: "คำนวณคะแนน (Calculate)",
                btnDlCard: "ดาวน์โหลดบัตรแพ้ยา (A5)",
                btnDlReport: "ดาวน์โหลดรายงานผล (A4)",
                resLabel: "ผลการประเมินครั้งนี้",
                alertDoubtful: "ผลประเมินเป็น Doubtful (≤ 0) ไม่สามารถออกเอกสารสำหรับรายการนี้ได้",
                alertNoData: "กรุณาเพิ่มรายการยาเก่า หรือทำการประเมินยาใหม่ให้สมบูรณ์",
                thDrug: "ยาที่แพ้ (Drug Name)", thSym: "อาการ (Symptoms)", thRes: "ผลประเมิน (Result)",
                c_lbl: { name: "ชื่อ-สกุล:", hn: "HN:", unit: "หน่วยงาน:", pharm: "เภสัชกร:", date: "Date:" }
            }
        };

        let currentLang = 'th';
        let historyItems = [];
        let assessmentResult = null; // Store calculation result

        document.addEventListener('DOMContentLoaded', () => {
            renderQuestions();
            setLanguage('th');
            document.getElementById('inp-date').valueAsDate = new Date();
        });

        function renderQuestions() {
            const tbody = document.getElementById('question-body');
            tbody.innerHTML = questions.map((q, i) => `
                <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-4 py-2 text-sm text-gray-900 q-text" data-idx="${i}">${q.th}</td>
                    <td class="text-center py-2"><input type="radio" name="q${i}" value="${q.y}" class="cursor-pointer"></td>
                    <td class="text-center py-2"><input type="radio" name="q${i}" value="${q.n}" class="cursor-pointer"></td>
                    <td class="text-center py-2"><input type="radio" name="q${i}" value="${q.u}" checked class="cursor-pointer"></td>
                </tr>
            `).join('');
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = uiText[lang];

            document.getElementById('app-title').textContent = t.title;
            document.getElementById('app-subtitle').textContent = t.subtitle;
            document.getElementById('sec-patient').textContent = t.secPatient;
            document.getElementById('sec-history').textContent = t.secHistory;
            document.getElementById('desc-history').textContent = t.descHistory;
            document.getElementById('sec-current').textContent = t.secCurrent;
            document.getElementById('lbl-enable-assess').textContent = t.lblEnable;
            document.getElementById('btn-calc-text').textContent = t.btnCalc;
            document.getElementById('btn-dl-card').textContent = t.btnDlCard;
            document.getElementById('btn-dl-report').textContent = t.btnDlReport;
            document.getElementById('res-label').textContent = t.resLabel;

            // Inputs
            document.getElementById('lbl-name').textContent = t.lbl.name;
            document.getElementById('lbl-hn').textContent = t.lbl.hn;
            document.getElementById('lbl-unit').textContent = t.lbl.unit;
            document.getElementById('lbl-date').textContent = t.lbl.date;
            document.getElementById('lbl-pharm').textContent = t.lbl.pharm;
            document.getElementById('lbl-license').textContent = t.lbl.license;
            document.getElementById('lbl-drug').textContent = t.lbl.drug;
            document.getElementById('lbl-symptom').textContent = t.lbl.sym;

            document.getElementById('hist-drug').placeholder = lang === 'th' ? "ชื่อยา" : "Drug Name";
            document.getElementById('hist-sym').placeholder = lang === 'th' ? "อาการ" : "Symptom";

            // Card Headers
            document.getElementById('th-drug').textContent = t.thDrug;
            document.getElementById('th-sym').textContent = t.thSym;
            document.getElementById('th-res').textContent = t.thRes;
            document.getElementById('c-lbl-name').textContent = t.c_lbl.name;
            document.getElementById('c-lbl-hn').textContent = t.c_lbl.hn;
            document.getElementById('c-lbl-unit').textContent = t.c_lbl.unit;
            document.getElementById('c-lbl-pharm').textContent = t.c_lbl.pharm;
            document.getElementById('c-lbl-date').textContent = t.c_lbl.date;

            document.querySelectorAll('.q-text').forEach(el => {
                const idx = el.dataset.idx;
                el.textContent = lang === 'th' ? questions[idx].th : questions[idx].en;
            });

             // Buttons Style
            const btnEn = document.getElementById('btn-en');
            const btnTh = document.getElementById('btn-th');
            if(lang === 'en') {
                btnEn.className = "px-4 py-1 rounded bg-white text-blue-700 shadow text-sm font-medium";
                btnTh.className = "px-4 py-1 rounded transition-colors text-sm font-medium text-blue-100 hover:text-white";
            } else {
                btnTh.className = "px-4 py-1 rounded bg-white text-blue-700 shadow text-sm font-medium";
                btnEn.className = "px-4 py-1 rounded transition-colors text-sm font-medium text-blue-100 hover:text-white";
            }
            renderHistoryList();
        }

        function addHistoryItem() {
            const drug = document.getElementById('hist-drug').value.trim();
            const sym = document.getElementById('hist-sym').value.trim();
            if (drug) {
                historyItems.push({ drug, sym });
                document.getElementById('hist-drug').value = '';
                document.getElementById('hist-sym').value = '';
                renderHistoryList();
            }
        }

        function removeHistoryItem(index) {
            historyItems.splice(index, 1);
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = historyItems.map((item, idx) => `
                <li class="flex justify-between items-center bg-white p-2 rounded border border-gray-200 text-sm">
                    <div><span class="font-bold">${item.drug}</span> - ${item.sym || '-'} <span class="bg-gray-200 text-xs px-1 rounded">History</span></div>
                    <button onclick="removeHistoryItem(${idx})" class="text-red-500 px-2 font-bold">✕</button>
                </li>
            `).join('');
        }

        function toggleAssessment() {
            const enabled = document.getElementById('chk-assess').checked;
            const panel = document.getElementById('assessment-panel');
            const msg = document.getElementById('assessment-disabled-msg');
            if(enabled) {
                panel.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                msg.classList.add('hidden');
            } else {
                panel.classList.add('hidden');
                msg.classList.remove('hidden');
            }
        }

        function getInterpretation(score) {
            if (score >= 9) return "Definite";
            if (score >= 5) return "Probable";
            if (score >= 1) return "Possible";
            return "Doubtful";
        }
        
        // --- Thai Interpretation Detail Function ---
        function getThaiInterpretationDetail(score) {
            if (score >= 9) return "ใช่แน่";
            if (score >= 5) return "น่าจะใช่";
            if (score >= 1) return "อาจจะใช่";
            return "ไม่น่าใช่";
        }

        // --- Main Calculation Logic ---
        function calculateAndShowResult() {
            document.getElementById('alert-box').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');
            
            const assessEnabled = document.getElementById('chk-assess').checked;
            let score = 0;
            let answers = [];

            if (assessEnabled) {
                for (let i = 0; i < questions.length; i++) {
                    const radios = document.getElementsByName(`q${i}`);
                    let selectedVal = 0;
                    let selectedType = 'u'; // y, n, u

                    // Find checked radio
                    // Radio values in DOM are strings "1", "0", "-1". 
                    // But questions array has correct values.
                    // We need to map index to type.
                    // Radio indices: 0=Yes, 1=No, 2=Unk
                    if(radios[0].checked) { selectedVal = questions[i].y; selectedType = 'y'; }
                    else if(radios[1].checked) { selectedVal = questions[i].n; selectedType = 'n'; }
                    else { selectedVal = questions[i].u; selectedType = 'u'; }
                    
                    score += selectedVal;
                    answers.push({ qIdx: i, type: selectedType, val: selectedVal });
                }

                const interp = getInterpretation(score);
                assessmentResult = {
                    score: score,
                    interp: interp,
                    drug: document.getElementById('inp-drug').value.trim(),
                    sym: document.getElementById('inp-symptom').value.trim(),
                    answers: answers,
                    isDoubtful: score <= 0
                };

                // Display
                const scoreEl = document.getElementById('score-val');
                scoreEl.textContent = score;
                
                // Display text on screen (using Thai in parentheses if TH language selected)
                const thaiInterpText = getThaiInterpretationDetail(score);
                document.getElementById('interp-val').textContent = 
                    `${interp}${currentLang === 'th' ? ` (${thaiInterpText})` : ''}`;


                // Color
                if(score <= 0) { scoreEl.className = "text-5xl font-extrabold text-gray-500"; }
                else if(score >= 9) { scoreEl.className = "text-5xl font-extrabold text-red-600"; }
                else if(score >= 5) { scoreEl.className = "text-5xl font-extrabold text-orange-500"; }
                else { scoreEl.className = "text-5xl font-extrabold text-green-600"; }

                // Show Result Container
                document.getElementById('result-container').classList.remove('hidden');
                
                // Logic for Buttons
                const btnReport = document.getElementById('btn-gen-report');
                
                if (assessmentResult.isDoubtful || !assessmentResult.drug) {
                     // Disable report button visuals or show alert if clicked
                     btnReport.classList.add('opacity-50', 'cursor-not-allowed');
                     btnReport.onclick = () => alert(uiText[currentLang].alertDoubtful);
                } else {
                     btnReport.classList.remove('opacity-50', 'cursor-not-allowed');
                     btnReport.onclick = generateReport;
                }

            } else {
                // Assessment Disabled (Only History)
                assessmentResult = null;
                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('score-val').textContent = "-";
                document.getElementById('interp-val').textContent = "History Only";
                
                // Disable Report Button (No Naranjo to report)
                const btnReport = document.getElementById('btn-gen-report');
                btnReport.classList.add('opacity-50', 'cursor-not-allowed');
                btnReport.onclick = () => alert("No assessment performed.");
            }
        }

        // --- Generator: A5 Card ---
        async function generateCard() {
            // Validate
            let itemsToPrint = [...historyItems.map(h => ({...h, res: currentLang === 'th'?"ประวัติเก่า (H)":"History (H)"}))];
            
            if (assessmentResult && !assessmentResult.isDoubtful && assessmentResult.drug) {
                itemsToPrint.push({
                    drug: assessmentResult.drug,
                    sym: assessmentResult.sym,
                    // MODIFIED LINE: Removed the parenthesized Thai translation for the card
                    res: `${assessmentResult.interp} (Score: ${assessmentResult.score})`
                });
            }

            if (itemsToPrint.length === 0) {
                alert(uiText[currentLang].alertNoData);
                return;
            }

            // Fill Card Data
            document.getElementById('c-val-name').innerText = document.getElementById('inp-name').value || "-";
            document.getElementById('c-val-hn').innerText = document.getElementById('inp-hn').value || "-";
            document.getElementById('c-val-unit').innerText = document.getElementById('inp-unit').value || "-";
            document.getElementById('c-val-date').innerText = document.getElementById('inp-date').value || "-";
            const pharm = document.getElementById('inp-pharm').value || "";
            const lic = document.getElementById('inp-license').value || "";
            document.getElementById('c-val-pharm').innerText = `${pharm} ${lic ? '('+lic+')' : ''}`;

            const tbody = document.getElementById('c-table-body');
            tbody.innerHTML = itemsToPrint.map(item => `
                <tr>
                    <td style="color: #1e40af; font-weight: 800;">${item.drug}</td>
                    <td style="color: #374151;">${item.sym || '-'}</td>
                    <td style="color: #047857; font-weight: 700;">${item.res}</td>
                </tr>
            `).join('');

            updateStatus("Generating Card (A5)...");
            await downloadPDF('pdf-card', 'a5', 'landscape', 'AllergyCard');
            updateStatus("");
        }

        // --- Generator: A4 Report ---
        async function generateReport() {
            if (!assessmentResult || assessmentResult.isDoubtful) {
                alert(uiText[currentLang].alertDoubtful);
                return;
            }

            // Fill Report Data
            document.getElementById('r-val-name').innerText = document.getElementById('inp-name').value || "-";
            document.getElementById('r-val-hn').innerText = document.getElementById('inp-hn').value || "-";
            document.getElementById('r-val-unit').innerText = document.getElementById('inp-unit').value || "-";
            document.getElementById('r-val-date').innerText = document.getElementById('inp-date').value || "-";
            document.getElementById('r-val-drug').innerText = assessmentResult.drug;
            document.getElementById('r-val-sym').innerText = assessmentResult.sym || "-";
            document.getElementById('r-val-score').innerText = assessmentResult.score;
            document.getElementById('r-val-interp').innerText = assessmentResult.interp;
            
            const pharm = document.getElementById('inp-pharm').value || "";
            const lic = document.getElementById('inp-license').value || "";
            document.getElementById('r-sig-pharm').innerText = `${pharm} ${lic ? '('+lic+')' : ''}`;

            // Fill Table Rows
            const rTbody = document.getElementById('r-table-body');
            rTbody.innerHTML = questions.map((q, i) => {
                const ans = assessmentResult.answers.find(a => a.qIdx === i);
                const markY = ans.type === 'y' ? '✓' : '';
                const markN = ans.type === 'n' ? '✓' : '';
                const markU = ans.type === 'u' ? '✓' : '';
                const score = ans.val;

                return `
                    <tr>
                        <td class="rpt-col-q">${q.en}<br><span style="color:#555;">${q.th}</span></td>
                        <td class="rpt-col-ans">${markY}</td>
                        <td class="rpt-col-ans">${markN}</td>
                        <td class="rpt-col-ans">${markU}</td>
                        <td class="rpt-col-score">${score}</td>
                    </tr>
                `;
            }).join('');

            updateStatus("Generating Report (A4)...");
            await downloadPDF('pdf-report', 'a4', 'portrait', 'NaranjoReport');
            updateStatus("");
        }

        // --- Shared PDF Function ---
        async function downloadPDF(elementId, format, orientation, filePrefix) {
            try {
                const element = document.getElementById(elementId);
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: null });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation, unit: 'mm', format });

                const imgProps = pdf.getImageProperties(imgData);
                const pageW = pdf.internal.pageSize.getWidth();
                const pageH = pdf.internal.pageSize.getHeight();
                const margin = 10;
                
                let finalW = pageW - (margin * 2);
                let finalH = (imgProps.height * finalW) / imgProps.width;

                // Fit height if needed
                if (finalH > (pageH - margin * 2)) {
                    const ratio = (pageH - margin * 2) / finalH;
                    finalW = finalW * ratio;
                    finalH = (pageH - margin * 2);
                }

                const x = (pageW - finalW) / 2;
                const y = (pageH - finalH) / 2; // Center vertically (optional, usually top align for report is better but center is fine)

                pdf.addImage(imgData, 'PNG', x, format === 'a4' ? 10 : y, finalW, finalH); // Top align for A4 report (y=10)
                
                const hn = document.getElementById('inp-hn').value;
                pdf.save(`${filePrefix}_${hn || 'Draft'}.pdf`);
            } catch (err) {
                console.error(err);
                alert("Error generating PDF");
            }
        }

        function updateStatus(msg) {
            document.getElementById('download-status').innerText = msg;
        }

    </script>
</body>
</html>

